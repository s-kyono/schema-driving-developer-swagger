name: Publish npm package

# 手動起動
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag to checkout'
        required: true
        default: 'v0.0.0'

jobs:
  pre_checkout_tag:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.tag }}

      - name: Verify Git tag
        run: git describe

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: ${{ runner.os }}-buildx-

      - name: Build Docker Image
        run: docker build --file ./Dockerfile.ci --tag openapi-tools:latest .
      - name: Run Docker Container
        run: docker run --name openapi-generator -d -v ${{ github.workspace }} :/workspace openapi-tools:latest

      - name: Verify Docker Container
        run: docker ps -a

      - name: Run Docker Exec Open API Generator Typescript Axios
        run: docker exec openapi-generator openapi-generator-cli generate -c /workspace/openapitools-axios.json -o /workspace/output/typescript/axios

      - name: Run Docker Exec Open API Generator Typescript Fetcher
        run: docker exec openapi-generator openapi-generator-cli generate -c /workspace/openapitools-fetch.json -o /workspace/output/typescript/fetch

      - name: Verify After Generation Schema Files
        run: ls -la ${{ github.workspace }}/output/typescript
